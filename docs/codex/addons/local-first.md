# Codex Add‑On · **Local‑First Tool Re‑Use**
*Save as `docs/codex/addons/local-first.md` and include it in every PR.*

This add‑on **overrides** any previous instruction that unconditionally
installs binaries.  Codex must **always attempt to use tools already present
on the runner _before_ reaching out to the Internet.**

---
## 1 · Detection Strategy 🕵️‍♂️

1. For each required CLI (`go`, `golangci-lint`, `gosec`, `trivy`, `goreleaser`, …):
   ```bash
   if command -v <tool> >/dev/null 2>&1; then
     <tool> --version   # capture banner
     # Optional: grep to ensure version string matches requirement
   fi
   ```
2. Proceed to **installation** only when:
   * the binary is **missing**, **or**
   * the version test fails (banner ≠ expected regex).

> **Tip:** Implement detection once (e.g., in `scripts/offline_first.sh`) and
> **SOURCE** that script in every Codex-generated Bash file instead of
> duplicating logic.

---
## 2 · Approved Install Paths 📦

* **Go ecosystem tools** — `go install <module>@<version>` (pin tag or `latest`).
* **APT packages**       — `sudo apt-get install -y <pkg>` (run a single
  `apt-get update -qq` first).
* **Standalone binaries**— Fetch from GitHub Releases → `/usr/local/bin`.

**Never** vendor a tool if the local copy already satisfies requirements.

---
## 3 · Coding Pattern (Template)

```bash
#!/usr/bin/env bash
set -euo pipefail
source ./scripts/offline_first.sh   # ensures tools
# … rest of the script …
```

* Codex should ALWAYS prefer sourcing the shared provisioner instead of
  rewriting inline install commands.

---
## 4 · Acceptance Test

A PR is **rejected** if its job logs show **any** install command when the
runner already contains a valid version.  Maintainers will grep for:

```text
🔧  Installing
```

If such a line appears for a tool whose version matches the regex, the PR
must be fixed.

---
## 5 · Examples

### ✅ Good
```text
✅  [local] go go1.24.4 linux/amd64
✅  [local] golangci-lint version 1.56.2 built from (…)
🎉  All required tools present
```

### ❌ Bad
```text
🔧  Installing golangci-lint …   # but version 1.56.2 already exists
```

---
## 6 · Scope & Precedence

* This add‑on supersedes **Always‑Online** §0 step 2 & 3 if they conflict.
* The CI/CD pipeline **remains immutable**; helper scripts are the place for
detection logic.

---
### 🏁 Rule of Thumb

> **Detect → Skip if present → Install only if necessary.**  Every script
> generated by Codex must follow this pattern—no exceptions.
