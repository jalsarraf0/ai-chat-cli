# Codex Addâ€‘On Â· **Localâ€‘First Tool Reâ€‘Use**
*Save as `docs/codex/addons/local-first.md` and include it in every PR.*

This addâ€‘on **overrides** any previous instruction that unconditionally
installs binaries.  Codex must **always attempt to use tools already present
on the runner _before_ reaching out to the Internet.**

---
## 1 Â· Detection Strategy ğŸ•µï¸â€â™‚ï¸

1. For each required CLI (`go`, `golangci-lint`, `gosec`, `trivy`, `goreleaser`, â€¦):
   ```bash
   if command -v <tool> >/dev/null 2>&1; then
     <tool> --version   # capture banner
     # Optional: grep to ensure version string matches requirement
   fi
   ```
2. Proceed to **installation** only when:
   * the binary is **missing**, **or**
   * the version test fails (banner â‰  expected regex).

> **Tip:** Implement detection once (e.g., in `scripts/offline_first.sh`) and
> **SOURCE** that script in every Codex-generated Bash file instead of
> duplicating logic.

---
## 2 Â· Approved Install Paths ğŸ“¦

* **Go ecosystem tools** â€” `go install <module>@<version>` (pin tag or `latest`).
* **APT packages**       â€” `sudo apt-get install -y <pkg>` (run a single
  `apt-get update -qq` first).
* **Standalone binaries**â€” Fetch from GitHub Releases â†’ `/usr/local/bin`.

**Never** vendor a tool if the local copy already satisfies requirements.

---
## 3 Â· Coding Pattern (Template)

```bash
#!/usr/bin/env bash
set -euo pipefail
source ./scripts/offline_first.sh   # ensures tools
# â€¦ rest of the script â€¦
```

* Codex should ALWAYS prefer sourcing the shared provisioner instead of
  rewriting inline install commands.

---
## 4 Â· Acceptance Test

A PR is **rejected** if its job logs show **any** install command when the
runner already contains a valid version.  Maintainers will grep for:

```text
ğŸ”§  Installing
```

If such a line appears for a tool whose version matches the regex, the PR
must be fixed.

---
## 5 Â· Examples

### âœ… Good
```text
âœ…  [local] go go1.24.4 linux/amd64
âœ…  [local] golangci-lint version 1.56.2 built from (â€¦)
ğŸ‰  All required tools present
```

### âŒ Bad
```text
ğŸ”§  Installing golangci-lint â€¦   # but version 1.56.2 already exists
```

---
## 6 Â· Scope & Precedence

* This addâ€‘on supersedes **Alwaysâ€‘Online** Â§0 step 2 & 3 if they conflict.
* The CI/CD pipeline **remains immutable**; helper scripts are the place for
detection logic.

---
### ğŸ Rule of Thumb

> **Detect â†’ Skip if present â†’ Install only if necessary.**  Every script
> generated by Codex must follow this patternâ€”no exceptions.
