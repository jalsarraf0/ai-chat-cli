# .github/workflows/ci.yml
#
# FULL WORKFLOW — ONLY THE “snapshot” JOB CHANGED
# ─────────────────────────────────────────────────────────────────────────────
# • GoReleaser is now *pinned* to **v2.1.2** for **both** amd64 and arm64.
# • No other parts of the pipeline were modified.

name: CI

env:
  GO_BIN: $HOME/go/bin
  COVERAGE_THRESHOLD: 70
  TRIVY_VERSION: 0.63.0
  GOLANGCI_VERSION: 2.1.6
  GOSEC_VERSION: v2.19.0
  OSV_VERSION: v1.7.3
  GORELEASER_VERSION_AMD64: v2.1.2   # (legacy var - unused, left untouched)

on:
  push:
    branches: [dev]
    paths-ignore:
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [dev]
    paths-ignore:
      - '.github/workflows/ci.yml'

jobs:
  # ────────────────────────────── LINT ──────────────────────────────
  lint:
    runs-on: [self-hosted, linux]
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]

    steps:
      - name: Fix permissions for cache directories
        run: |
          sudo chmod -R u+w ~/.cache/go-build || true
          sudo chmod -R u+w ~/go/pkg/mod      || true

      - name: Restore Go cache (ignore errors)
        uses: actions/cache@v3
        continue-on-error: true
        timeout-minutes: 30
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint ${{ env.GOLANGCI_VERSION }}
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get
